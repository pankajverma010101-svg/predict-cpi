<!DOCTYPE html>
<html>

<head>
    <title>Testing - Bid details</title>

    <script src="https://cdn.jsdelivr.net/npm/tinymce@4.9.11/tinymce.min.js"></script>
    <script>
        tinymce.init({
            selector: '#userText',
            plugins: 'table paste',
            toolbar: 'undo redo | bold italic underline | alignleft aligncenter alignright | table',
            menubar: false,
            height: 300
        });
    </script>

</head>

<style>
    .button {
        border: none;
        color: white;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 12px;
        margin: 4px 2px;
        cursor: pointer;
        background-color: #04AA6D;
        border-radius: 6px;
    }

    .clear-btn {
        background-color: #f44336; /* Red */
    }

    .button:disabled {
        background-color: #9e9e9e; /* Grey when disabled */
        cursor: not-allowed;
    }
</style>

<body>

    <h3>Enter Bid Details</h3>
    <textarea id="userText"></textarea>
    <br>
    <button class="button" id="submitBtn" onclick="sendText()">Submit</button>
    <button class="button clear-btn" onclick="clearText()">Clear</button>

    <h5> CPI response </h5>
    <pre id="responseOutput"></pre>

    <script>
        function sendText() {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.innerText = "Submitting...";
            submitBtn.disabled = true;

            const userText = tinymce.get('userText').getContent();

            fetch('/api/submit-text/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ text: userText })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status == 'fail') {
                        document.getElementById('responseOutput').innerText =
                            data.msg + " : " + JSON.stringify(data.message, null, 2)
                    }
                    else {
                        const structured = data.structured_data || {};
                        const predictedCPI = data.message?.predicted_final_cpi ?? 'N/A';

                        function safe(value) {
                            return value ?? 'N/A';
                        }

                        function multiline(value) {
                            return safe(value).replace(/\n/g, '<br>');
                        }

                        document.getElementById('responseOutput').innerHTML =
                            `<div style="font-size: 14px;">` +
                                 `<div style="padding: 5px; margin-bottom:5px; background-color: #e8f5e9; border-left: 5px solid #4caf50;">
        <strong>Predicted Final CPI:</strong> ${predictedCPI}
     </div>` +
                            `<b>Status:</b> ${safe(data.status)}<br><br>` +
                            `<b>Market:</b> ${safe(structured.market)}<br>` +
                            `<b>Sample Size (n):</b> ${safe(structured.n)}<br>` +
                            `<b>Target Audience:</b> ${multiline(structured.target_audience)}<br>` +
                            `<b>Industries:</b> ${multiline(structured.industries)}<br>` +
                            `<b>Incidence Rate (IR):</b> ${safe(structured.ir)}<br>` +
                            `<b>Length of Interview (LOI):</b> ${safe(structured.loi)}<br>` +
                            `<b>Devices:</b> ${safe(structured.devices)}<br>` +
                            `<b>Survey Topic:</b> ${safe(structured.survey_topic)}<br>` +
                            `<b>Survey Type:</b> ${safe(structured.survey_type)}<br>` +
                            `<b>Quotas:</b> ${safe(structured.quotas)}<br>` +
                            `<b>Field Time:</b> ${safe(structured.field_time)}<br>` +
                            `<b>Feasibility:</b> ${safe(structured.feasibility)}<br>` +
                            `</div>`;
                    }
                })
                .catch(err => {
                    document.getElementById('responseOutput').innerText = "Error: " + err;
                })
                .finally(() => {
                    submitBtn.innerText = "Submit";
                    submitBtn.disabled = false;
                });
        }

        function clearText() {
            tinymce.get('userText').setContent(''); // Clear TinyMCE editor
            document.getElementById('responseOutput').innerText = ''; // Clear output
        }

        function getCSRFToken() {
            let cookieValue = null;
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith('csrftoken=')) {
                    cookieValue = cookie.substring('csrftoken='.length);
                    break;
                }
            }
            return cookieValue;
        }
    </script>
</body>

</html>
