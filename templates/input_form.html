
  
<!DOCTYPE html>
<html>
<head>
    <title>Testing - Bid details</title>

    <script src="https://cdn.jsdelivr.net/npm/tinymce@4.9.11/tinymce.min.js"></script>
    <script>
        tinymce.init({
            selector: '#userText',
            plugins: 'table paste',
            toolbar: 'undo redo | bold italic underline | alignleft aligncenter alignright | table',
            menubar: false,
            height: 300,
            setup: function (editor) {
            // ðŸ‘‰ Clear result + dropdowns on typing or pasting
            editor.on('input paste', function () {
                document.getElementById('responseOutput').innerText = '';
                document.getElementById('businessSelect').value = '';
                document.getElementById('clientSelect').value = '';
            });
        }
        });
    </script>

    <style>
        .button {
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 12px;
            margin: 4px 2px;
            cursor: pointer;
            background-color: #04AA6D;
            border-radius: 6px;
        }

        .clear-btn {
            background-color: #f44336; /* Red */
        }

        .button:disabled {
            background-color: #9e9e9e; /* Grey when disabled */
            cursor: not-allowed;
        }

        .client-dropdown {
            padding: 12px;
            font-size: 12px;
            border-radius: 6px;
            margin-left: 10px;
        }

        .business-dropdown {
            padding: 12px;
            font-size: 12px;
            border-radius: 6px;
            margin-left: 10px;
        }
    </style>
</head>

<body>
    <h3>Enter Bid Details</h3>
    <textarea id="userText"></textarea>
    <br>
   
    <!-- Dropdowns beside Clear button -->
   

    <select id="businessSelect" class="business-dropdown">
        <option value="">Select Business Type</option>
        <option value="B2B">B2B</option>
        <option value="B2C">B2C</option>
    </select>

     <select id="clientSelect" class="client-dropdown">
        <option value="">Select Client</option>
    </select>

    <button class="button" id="submitBtn" onclick="sendText()">Submit</button>
    <button class="button clear-btn" onclick="clearText()">Clear</button>

    <h5> CPI Response </h5>
    <pre id="responseOutput"></pre>

    <script>
        // ðŸ‘‰ Store clients in array
        const clients = [
            "acuity",
            "Innovate MR",
            "Paradigm Sample",
            "Pure Profile AU Pty",
            "IR Bureau",
            "Empanel Online",
            "Azure Knowledge Corporation",
            "Acuity Knowledge Partners",
            "RepDataLLC",
            "phronesis",
            "Qualtrics",
            "Quantifyai",
            "Toluna",
            "Cint",
            "Divergent Insights",
            "Ipsos Interactive Services",
            "Opinionroute",
            "Tehrihills",
            "Bilendi",
            "DashMR",
            "Gerson Lehrman Group",
            "IVY Exec",
            "Logit Group",
            "Potloc",
            "Symmetric Sampling",
            "Wearehuman8"
        ];

        // ðŸ‘‰ Populate client dropdown dynamically
        const clientSelect = document.getElementById("clientSelect");
        clients.forEach(client => {
            const option = document.createElement("option");
            option.value = client;
            option.textContent = client;
            clientSelect.appendChild(option);
        });

        function sendText() {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.innerText = "Submitting...";
            submitBtn.disabled = true;

            const userText = tinymce.get('userText').getContent();
            const clientName = document.getElementById('clientSelect').value;
            const businessType = document.getElementById('businessSelect').value;

            fetch('/api/submit-text/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ text: userText, client_name: clientName, business_type: businessType })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status == 'fail') {
                    document.getElementById('responseOutput').innerText =
                        data.msg + " : " + JSON.stringify(data.message, null, 2)
                }
                else {
                    const structured = data.structured_data || {};
                    const predictedCPI = data.message?.predicted_price ?? 'N/A';

                    function safe(value) {
                        return value ?? 'N/A';
                    }

                    // Auto select B2B/B2C if API returns it
                    if (data.business_type) {
                        document.getElementById('businessSelect').value = data.business_type.toUpperCase();
                    }

                    document.getElementById('responseOutput').innerHTML =
                        `<div style="font-size: 14px;">` +
                             `<div style="padding: 5px; margin-bottom:5px; background-color: #e8f5e9; border-left: 5px solid #4caf50;">
        <strong>Predicted Final CPI:</strong> ${predictedCPI}
     </div>` +
                        `<b>Business Type:</b> ${safe(data.business_type)}<br>` +
                        `<b>Market:</b> ${safe(structured.market)}<br>` +
                        `<b>Incidence Rate (IR):</b> ${safe(structured.ir)}<br>` +
                        `<b>Length of Interview (LOI):</b> ${safe(structured.loi)}<br>` +
                        `</div>`;
                }
            })
            .catch(err => {
                document.getElementById('responseOutput').innerText = "Error: " + err;
            })
            .finally(() => {
                submitBtn.innerText = "Submit";
                submitBtn.disabled = false;
            });
        }

        function clearText() {
            tinymce.get('userText').setContent('');
            document.getElementById('responseOutput').innerText = '';
            document.getElementById('clientSelect').value = '';
            document.getElementById('businessSelect').value = '';
        }

        function getCSRFToken() {
            let cookieValue = null;
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith('csrftoken=')) {
                    cookieValue = cookie.substring('csrftoken='.length);
                    break;
                }
            }
            return cookieValue;
        }

        // ðŸ‘‰ Auto call API when business type is changed
        document.getElementById("businessSelect").addEventListener("change", function() {
            if (this.value) {
                sendText();
            }
        });
    </script>
</body>
</html>
